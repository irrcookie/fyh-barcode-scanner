<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYH Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* CSS æ¨£å¼å®šç¾© */
        body { font-family: sans-serif; text-align: center; margin: 20px; background-color: #f4f4f9; }
        .logo { max-width: 150px; height: auto; margin-bottom: 15px; } 
        h1 { color: #333; font-size: 24px; margin-top: 5px; }
        #reader { width: 100%; max-width: 400px; margin: 0 auto; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .result-box { background: white; padding: 15px; border-radius: 5px; margin-top: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input[type="text"] { width: 90%; padding: 10px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        
        /* æäº¤æŒ‰éˆ•æ¨£å¼ */
        .submit-btn { 
            background-color: #28a745; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 18px; 
            margin-top: 10px; 
            margin-bottom: 5px; 
            width: 90%;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .submit-btn:hover { 
            background-color: #1e7e34; 
        }
        /* é‡æ–°æƒææŒ‰éˆ•æ¨£å¼ */
        .retake-btn {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            margin-top: 5px;
            width: 90%;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .retake-btn:hover {
            background-color: #5a6268;
        }
        /* éš±è—å…ƒç´  */
        .hidden {
            display: none !important;
        }
        .status-message { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    
    <img src="https://www.fuyunhon.com/wp-content/uploads/logo.jpg" alt="FYH Logo" class="logo">
    
    <h1>FYH Barcode Scanner</h1>
    
    <div id="reader"></div>

    <div class="result-box">
        <label for="barcode_input">æƒæåˆ°çš„è™Ÿç¢¼ï¼š</label>
        <input type="text" id="barcode_input" readonly placeholder="è«‹æƒææ¢ç¢¼æˆ– QR Code">
        
        <button onclick="confirmSubmission()" class="submit-btn">âœ… ç›´æ¥æäº¤ç´€éŒ„</button>
        
        <button onclick="retake()" class="retake-btn hidden" id="retakeButton">ğŸ”„ é‡æ–°æƒæ (Retake)</button>
        
        <p class="status-message" id="status"></p>
    </div>

    <script>
        // ğŸ“Œ Google Form æäº¤çµ‚é» URL
        const FORM_SUBMISSION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfZUGam9VPr8zRp5KqoW5V2V-egh_1euYde99oVT0HQ_M_NAw/formResponse'; 
        
        // ğŸ“Œ Google Form æ¢ç¢¼æ¬„ä½åç¨± (entry ID)
        const BARCODE_ENTRY_ID = 'entry.1388839353'; 

        const html5Qrcode = new Html5Qrcode("reader");
        const barcodeInput = document.getElementById("barcode_input");
        const statusMessage = document.getElementById("status");
        const retakeButton = document.getElementById("retakeButton"); // ç²å–æŒ‰éˆ•å…ƒç´ 
        
        // å•Ÿå‹•æƒæå™¨å‡½æ•¸
        function startScanner() {
            // æ¯æ¬¡å•Ÿå‹•æ™‚ï¼Œå…ˆéš±è— Retake æŒ‰éˆ•
            retakeButton.classList.add('hidden');

            if (html5Qrcode.isScanning) {
                html5Qrcode.stop().then(() => {
                    _executeStartScanner();
                }).catch(() => {
                    _executeStartScanner();
                });
            } else {
                _executeStartScanner();
            }
        }

        // å¯¦éš›åŸ·è¡Œå•Ÿå‹•çš„å‡½æ•¸
        function _executeStartScanner() {
            const config = { 
                fps: 10, 
                qrbox: { width: 300, height: 150 }, 
                facingMode: "environment" 
            };

            html5Qrcode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
            .catch((err) => {
                 statusMessage.textContent = "âŒ é¡é ­å•Ÿå‹•å¤±æ•—ï¼è«‹æª¢æŸ¥æ¬Šé™ã€‚";
                 console.error("Camera start failed:", err);
            });
        }
        
        // æƒææˆåŠŸè™•ç†å‡½æ•¸
        function onScanSuccess(decodedText, decodedResult) {
            barcodeInput.value = decodedText;
            statusMessage.textContent = "âœ… æƒææˆåŠŸï¼š" + decodedText;
            
            // *** æƒææˆåŠŸå¾Œï¼Œé¡¯ç¤º Retake æŒ‰éˆ• ***
            retakeButton.classList.remove('hidden');

            // æƒææˆåŠŸå¾Œåœæ­¢é¡é ­ï¼Œç­‰å¾…ç”¨æˆ¶æ“ä½œ
            html5Qrcode.stop().then(() => {}).catch(() => {});
        }
        
        function onScanError(errorMessage) {}

        // --- é‡æ–°æƒæå‡½æ•¸ ---
        function retake() {
            // *** é‡æ–°æƒææ™‚ï¼Œéš±è— Retake æŒ‰éˆ• ***
            retakeButton.classList.add('hidden');
            
            barcodeInput.value = ""; 
            statusMessage.textContent = "è«‹å°æº–ä¸‹ä¸€å€‹æ¢ç¢¼ã€‚";
            startScanner(); // é‡æ–°å•Ÿå‹•æƒæå™¨
        }

        // --- å½ˆå‡ºç¢ºèªè¦–çª—ä¸¦è™•ç†çµæœ ---
        function confirmSubmission() {
            const barcode = barcodeInput.value;
            if (!barcode) { 
                statusMessage.textContent = "âš ï¸ è«‹å…ˆæƒææ¢ç¢¼ï¼";
                return;
            }
            
            const isConfirmed = window.confirm(`ä½ ç¢ºå®šè¦æäº¤æ¢ç¢¼ï¼š${barcode} å—ï¼Ÿ`);

            if (isConfirmed) {
                submitData(barcode);
            } else {
                // å¦‚æœå–æ¶ˆï¼Œå‰‡åŸ·è¡Œ Retake æ“ä½œ
                retake(); 
            }
        }
        
        // --- æ ¸å¿ƒæäº¤å‡½æ•¸ (æˆåŠŸå¾Œè·³è½‰åˆ° success.html) ---
        function submitData(barcode) {
            statusMessage.textContent = "â³ æ•¸æ“šå‚³è¼¸ä¸­ï¼Œè«‹ç¨å€™...";
            
            const formData = new FormData();
            formData.append(BARCODE_ENTRY_ID, barcode);

            fetch(FORM_SUBMISSION_URL, {
                method: 'POST',
                body: new URLSearchParams(formData),
                redirect: 'manual' 
            })
            .then(response => {
                if (response.status === 302 || response.type === 'opaque') {
                    // æˆåŠŸå¾Œï¼Œè·³è½‰åˆ° success.html é é¢
                    // åœ¨è·³è½‰å‰ï¼Œä¸éœ€è¦éš±è— Retake æŒ‰éˆ•ï¼Œå› ç‚ºé é¢æœƒè¢«æ›¿æ›ã€‚
                    window.location.href = 'success.html'; 
                } else {
                    statusMessage.textContent = "âŒ æäº¤å¤±æ•—ï¼Form æœå‹™å™¨éŒ¯èª¤ã€‚";
                    console.error('Form submission failed with status:', response.status);
                    startScanner(); // å¤±æ•—å¾Œé‡æ–°å•Ÿå‹•
                }
            })
            .catch(error => {
                statusMessage.textContent = "âŒ å‚³è¼¸å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²çµ¡æˆ– Forms è¨­å®šã€‚";
                console.error('çœŸæ­£çš„ç¶²çµ¡éŒ¯èª¤:', error);
                startScanner(); // å¤±æ•—å¾Œé‡æ–°å•Ÿå‹•
            });
        }

        // é é¢è¼‰å…¥å¾Œï¼Œç«‹å³å•Ÿå‹•æƒæå™¨
        startScanner();
    </script>
</body>
</html>
