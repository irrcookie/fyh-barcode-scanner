<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYH Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* CSS æ¨£å¼å®šç¾© */
        body { font-family: sans-serif; text-align: center; margin: 20px; background-color: #f4f4f9; }
        .logo { max-width: 150px; height: auto; margin-bottom: 15px; } 
        h1 { color: #333; font-size: 24px; margin-top: 5px; }
        /* é¡é ­é¡¯ç¤ºå€åŸŸï¼Œä¿æŒæœ€å¤§å¯¬åº¦é™åˆ¶ */
        #reader { width: 100%; max-width: 400px; margin: 0 auto; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .result-box { background: white; padding: 15px; border-radius: 5px; margin-top: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input[type="text"] { width: 90%; padding: 10px; margin: 10px 0; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        /* æäº¤æŒ‰éˆ•é¡è‰²èª¿æ•´ */
        button { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; margin-top: 10px; }
        button:hover { background-color: #1e7e34; }
        .status-message { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    
    <img src="https://www.fuyunhon.com/wp-content/uploads/logo.jpg" alt="FYH Logo" class="logo">
    
    <h1>FYH Barcode Scanner</h1>
    
    <div id="reader"></div>

    <div class="result-box">
        <label for="barcode_input">æƒæåˆ°çš„è™Ÿç¢¼ï¼š</label>
        <input type="text" id="barcode_input" readonly placeholder="è«‹æƒææ¢ç¢¼æˆ– QR Code">
        
        <button onclick="confirmSubmission()">âœ… ç›´æ¥æäº¤ç´€éŒ„</button>
        
        <p class="status-message" id="status"></p>
    </div>

    <script>
        // ğŸ“Œ Google Form æäº¤çµ‚é» URL
        const FORM_SUBMISSION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfZUGam9VPr8zRp5KqoW5V2V-egh_1euYde99oVT0HQ_M_NAw/formResponse'; 
        
        // ğŸ“Œ Google Form æ¢ç¢¼æ¬„ä½åç¨± (entry ID)
        const BARCODE_ENTRY_ID = 'entry.1388839353'; 

        const html5Qrcode = new Html5Qrcode("reader");
        const barcodeInput = document.getElementById("barcode_input");
        const statusMessage = document.getElementById("status");
        
        // å•Ÿå‹•æƒæå™¨å‡½æ•¸
        function startScanner() {
            // å…ˆæª¢æŸ¥ä¸¦åœæ­¢æ­£åœ¨é‹è¡Œçš„æƒæå™¨ï¼Œä»¥ç¢ºä¿é‡æ–°å•Ÿå‹•
            if (html5Qrcode.isScanning) {
                html5Qrcode.stop().then(() => {
                    // ç¢ºä¿åœæ­¢å¾Œæ‰å•Ÿå‹•
                    _executeStartScanner();
                }).catch(() => {
                    // å¦‚æœåœæ­¢å¤±æ•—ï¼Œä¹Ÿå˜—è©¦å•Ÿå‹•
                    _executeStartScanner();
                });
            } else {
                _executeStartScanner();
            }
        }

        // å¯¦éš›åŸ·è¡Œå•Ÿå‹•çš„å‡½æ•¸
        function _executeStartScanner() {
            // *** é€™è£¡è¨­å®šäº†é•·æ–¹å½¢æƒææ¡† (width: 300, height: 150) ***
            const config = { 
                fps: 10, 
                // å¯¬ 300pxï¼Œé«˜ 150px
                qrbox: { width: 300, height: 150 }, 
                facingMode: "environment" 
            };

            html5Qrcode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
            .catch((err) => {
                 statusMessage.textContent = "âŒ é¡é ­å•Ÿå‹•å¤±æ•—ï¼è«‹æª¢æŸ¥æ¬Šé™ã€‚";
                 console.error("Camera start failed:", err);
            });
        }
        
        // æƒææˆåŠŸè™•ç†å‡½æ•¸
        function onScanSuccess(decodedText, decodedResult) {
            barcodeInput.value = decodedText;
            statusMessage.textContent = "âœ… æƒææˆåŠŸï¼š" + decodedText;
            // æƒææˆåŠŸå¾Œåœæ­¢é¡é ­ï¼Œç­‰å¾…ç”¨æˆ¶ç¢ºèªæäº¤
            html5Qrcode.stop().then(() => {}).catch(() => {});
        }
        
        function onScanError(errorMessage) {}

        // --- å½ˆå‡ºç¢ºèªè¦–çª—ä¸¦è™•ç†çµæœ ---
        function confirmSubmission() {
            const barcode = barcodeInput.value;
            if (!barcode) { 
                statusMessage.textContent = "âš ï¸ è«‹å…ˆæƒææ¢ç¢¼ï¼";
                return;
            }
            
            const isConfirmed = window.confirm(`ä½ ç¢ºå®šè¦æäº¤æ¢ç¢¼ï¼š${barcode} å—ï¼Ÿ`);

            if (isConfirmed) {
                submitData(barcode);
            } else {
                // å¦‚æœå–æ¶ˆï¼Œå‰‡é‡æ–°å•Ÿå‹•æƒæ
                barcodeInput.value = ""; 
                statusMessage.textContent = "å·²å–æ¶ˆæäº¤ã€‚é‡æ–°å•Ÿå‹•æƒæå™¨...";
                startScanner(); 
            }
        }
        
        // --- æ ¸å¿ƒæäº¤å‡½æ•¸ (æˆåŠŸå¾Œè·³è½‰åˆ° success.html) ---
        function submitData(barcode) {
            statusMessage.textContent = "â³ æ•¸æ“šå‚³è¼¸ä¸­ï¼Œè«‹ç¨å€™...";
            
            const formData = new FormData();
            formData.append(BARCODE_ENTRY_ID, barcode);

            fetch(FORM_SUBMISSION_URL, {
                method: 'POST',
                body: new URLSearchParams(formData),
                // é˜»æ­¢ fetch è¿½è¹¤ 302 é‡æ–°å°å‘
                redirect: 'manual' 
            })
            .then(response => {
                // æª¢æŸ¥æ˜¯å¦æˆåŠŸæ¥æ”¶ (302 æˆ– opaque)
                if (response.status === 302 || response.type === 'opaque') {
                    // *** æˆåŠŸå¾Œï¼Œè·³è½‰åˆ° success.html é é¢ ***
                    // ç¢ºä¿ success.html æª”æ¡ˆå·²ä¸Šå‚³åˆ° GitHub æ ¹ç›®éŒ„
                    window.location.href = 'success.html'; 
                } else {
                    statusMessage.textContent = "âŒ æäº¤å¤±æ•—ï¼Form æœå‹™å™¨éŒ¯èª¤ã€‚";
                    console.error('Form submission failed with status:', response.status);
                    startScanner(); // å¤±æ•—å¾Œé‡æ–°å•Ÿå‹•
                }
            })
            .catch(error => {
                statusMessage.textContent = "âŒ å‚³è¼¸å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²çµ¡æˆ– Forms è¨­å®šã€‚";
                console.error('çœŸæ­£çš„ç¶²çµ¡éŒ¯èª¤:', error);
                startScanner(); // å¤±æ•—å¾Œé‡æ–°å•Ÿå‹•
            });
        }

        // é é¢è¼‰å…¥å¾Œï¼Œç«‹å³å•Ÿå‹•æƒæå™¨
        startScanner();
    </script>
</body>
</html>
